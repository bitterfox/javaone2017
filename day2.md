# Day2

## Preventing Errors Before They Happen [TUT3045]
- Java's type system is too weak
  - It allows code will occur NullPointerException or UnsupportedOperationException for readonly collection
  - In addition, it also allows non-exceptional evel/vulnerable code like including SQL injectionable code.
    - To prevent it classify the data to `@Tained`(User's input, not-yet sanitaized) and `@Untained`(Sanitaized)
    - CheckerFramework checks that there is a possibility of SQL Injection and gurantiee that there is no SQL Injection
- Pluggable Type Checking
  - Run optional type checkers runs after ordinaly compiler
    - Optional type checkers can be multiple and chooseable
- Preventing NullPointerException
  - `@NonNull`, `@Nullable`
  - It actually find NPE in JUnit4
- Benefits of type systems
  - Find bugs in programs
  - Improve documentation
    - Improve maintainability
  - Aid compiler, optimizers and analysis tools
  - Possible negatives
    - Must write tye type
    - False positive
- CheckerFramework
  - https://github.com/typetools/checker-framework
  - Plugs it into OpenJDK or Oracle JDK compiler
  - Integrated Maven, Gradle, NetBeans, IntelliJ, Eclipse
  - It can detect NPE code which can not be detected by other nullness tools like FindBugs, Jlint, PMD
    - Eclipse also cannot detect
    - IntelliJ can detect some of errors but a lot of writing annotation in about a thouthount places
  - Example type systems
    - Null dereferences
    - Equality tests
    - Concurrency locking
    - Fake enumerations/ typedefs
    - String type systems
      - Regular expression
      - printf format
      - methodsignature format
      - compiler messages
    - Security type systems
      - Command injection vulnerabilities
      - Information flow privacy
  - Checkers are usable
    - type checking is familiar to programmers
    - Modular: fast, incremental, partial programmers
    - Annotations are not too verbose
    - Few false positives
  - There is `no bugs` and `no wrong annotations` in programs which satisfies the type property
    - But, it doesn't when
      - it's only for code that is checked: Native method invocation, reflection, and so on
      - the checker-self has a error
  - facilities
    - Full type systems, Generics, Qualifier defaults, pre/post conditions, warning supression
      - Flexible mecanism for Qualifier defaults
- Demo
  - Regex checker
    - `@Regex` requires valid Regex
    - `@Regex(2)` requires valid Regex with 2+ capturing groups
    - It can detect errors at `Pattern#compile` and `Matcher#group`
    - Using `RegexUtil#isRegex` to convert ordinary string to `@Regex String`
       ```
      if (RegexUtil.isRegex(regex, 2)) return;
      @Regex(2) String it = regex; // ok
      ```
      - We can declare post-condition at method
- Type Annotations
  - We cannot express following before Java 8
    - non-null
  - After Java 8, there is type annotations and we can expression
    - Type Annotation at every type appears
  - For Java 6 & 7 compatibilities, it can be wrote in comments
    - `/* @NonNull */ String hogehoge`
- Considering type checker
  - Consider following
    - What runtime exception to prevent?
    - What properties of data should always hold? (devide data in the world)
    - What operation are illegal and legal?
  - Ex)Nullness checker
    - What runtime exception to prevent?
      - NPE
    - What properties of data should always hold? (devide data in the world)
      - NoNull references always NonNull
    - What operation are illegal and legal?
      - Derefecnce @NonNull value is illegal
- Building new type checker
  - Defining a type systems
    - Defining qualifier hierarcy
    - Type introduction rules
      - `@ImplicitFor`, `@DefaultForUnannotatedCode`
    - Type rules
      - checker-specific errors
      - Extends `HogeHogeVisitor` and override `visitHogeHoge`
    - Flow-refinement
      - Detaflow Framework does this
        - Compute properties about expressions
  - Ex) Encripted checker
    - Declare new annotation with `@SubtypeOf`
    - Use `SubtypingChecker` which is generic checker and checks subtype relation
      - Or, build you own type checker
    - Use `@SuppressWarning` at where we want ignore errors
      - Or, fix codes
  - Test it using jtreg or lightweight tester
- Q&A
  - Can annotate library
    - Yes. there is a stub parser

## Twitterâ€™s Quest for a Wholly Graal Runtime [CON5989]
- The goal of Twitter VM Teams is save the money
- Twitter has huge distributed systems
  - 1000+ JVM runs on 1000+ machines
    - Based on OpenJDK 8 with Graal
- Twitter uses a lot of OSS
  - Graal fits this situation
- Why Graal
  - C2 is old and very complex
  - Graal is easier to understand because it's modular designed
  - Better inlining and escape analysis
- bugs
  - #128
  - #263
  - #204
    - Heapster
  - #206
- Contributions
  - #251
- Numbers
  - Finagle-Thrift service
    - Runs 100% on Graal in production
  - Test setup
    - 1 dedicated machine per instance and all instances recieve the exact same request
    - Run with `jvmci-0.30` and `graal-vm-0.22`
      - Default tiered C1/Graal setup
  - Request per sec is mostly same between C2 and Graal
  - But Graal's Scavenge Cycles is smaller number than C2
    - about -2.7%~-2.5%
  - Memory usage increace 40MB
  - Use CPU Time decreace 11%
- Simplely, we can consider cost decreace 11%
- In JDK10, Graal will be experimental JIT compiler
- Note that Twitter uses Scala on Graal, so Java, Python, etc.. on Graal might be different result?
- Issues with Graal
  - Bootstrap issues
    - It's not actual issue on production
    - If it's issue in your env, AOT will solve
  - Use more Java Heap

## JDK 9 Hidden Gems [CON4529]
- Tools & Libraries
  - jshell(REPL tool) with Demo
    - well documentation feature(Showing signature, javadoc)
  - List#of
    - Immutable collection factories
    - The list is optimized
  - Stream#takeWhile, dropWhile
  - Optimization of String concatation
    - Using invokedynamic
- JVM/Hotspot
  - Make G1GC as a the default GC
  - CMS is deprecated and will be removed in future release(JEP 291)
  - Remove GC combination which is deprecated in JDK8(JEP 214)
  - Store interned String in CDS Achives(JEP 250)
    - String is storead shared in Class Data Sharing
    - Strings are shared across Java instances
    - Application CDS
    - Improve startup time(about 1.3 times faster, 70%) and footprint
      - 10 instance -> 10+% saving in total memory footprint
  - Ahead of Time compilication
    - Does with JIT compiled java code what AppCDS does with java class Data
      - Share the result of JIT compiler?
      - Still experimentain in JDK9, only on linux-x64
      - Improve statup performance, reduce time to peek performance, saves on footprint by sharing across instance
        - see image
  - Flight Recorder
    - Opensourced
  - Unified logging
  - and more and more features, see image
- Performance
  - Vectorization Enhancements
    - Vectorization extended to 512 bits, AVX-512
      - JIT's code generation
      - -XX:-UseSuperWord, -XX:UseAVX=2, 3, -XX:ObjectAlignmentInBytes=64
      - upto 150~180%
      - Stream is also faster
    - superunroll
    - More Vectorization
      - `Math#sqrt` is now supported and 6 times faster
  - Compact String
    - Memory usage is 20% less than JDK8
    - 5% better throughput
    - Optimized Math Libraries
      - exp, pow, sin, cos, etc.. are Optimized
      - 200 ~ 600% faster
    - Crypto Accelaration
      - SHA-250, AES CTR, etc... are optimized
        - 200%~1000% faster
    - Compression Accelaration
      - JRE's zip uses software accelaration and hardware accelaration in addition to system zlib
      - 150 ~ 300% faster
    - New Checksum Application
      - CRC32 and CRC32C
    - New Array Process Application
      - Lexicographic Array compare API
        - Array.compare
      - Benefit in big data like Cassandora HBase which uses array as a key
    - New FMA API

## Java Keynote [KEY7692]
- Core Foundattion
  - Communication
  - Community
  - Collaboration
  - Contributions
  - Female JUG
- Optimization from Intel
  - Data is increacing
  - Speed
    - 73 times faster in 10 years
      - in this year, its 110x faster
  - Scale
    - 3D NAND
      - lower cost, more capacity
    - Persistent Memory
      - Remove file-system, driver, no overhead
    - Persistent Collections for Java
      - https://github.com/pmem/pcj
    - Allibaba
      - 1 million JVM in DC
      - They have their cusomized JDK
      - There is 175,000 transaction / sec
    - Representative workload
      - Databench
        - https://github.com/Data-Bench
  - Smart(AI, Smart decision)
    - BigDL
    - AVX512 acceleration for AI on Java
    - Vectorization
      - Panama with Demo
      - Vector API Developer program
- Java EE goes to Eclipse
  - Now it runs on Java 8 and nimble evolution
- Java SE
  - 9 is released
  - 6 montly release
- Spotify moving to Java from Python
- Kubernetes + Java
- Wercker + Java
  - Demo: Diagnosis memory leak of Java app using Wercker
- FnProject
  - Serverless
  - Java FDK?
  - https://github.com/fnproject/fn
- Java SE
  - 9 is out
    - which means Jigsaw is also out
    - Jigsaw
      - -classpath
      - Monolithic JDK
      - module = set of packaged designed for re-use
      - --module-path
    - Docker + Jigsaw + jlink Demo
    - Jigsaw don't break everything
      - but something ;)
      - If your code depend on only standard API, it mostly works fine
      - cannot compile, but run with warn
        - In future it doesn't run
        - Use `jdeps` to analyze dependencies
    - jshell
    - Collection factories
    - Javadoc search box
    - Module graph in Javadoc
    - Enhancement `@Deprecated`
    - Integeration with IDE(IntelliJ, Eclipse is already integrated, NetBeans will be soon)
      - Jigsaw Integeration
      - Code conversion from old collection factories to modern collection factories
  - Future
    - 6 monthly release to increase speed of evolution
    - LTS supports for 3 years
    - Project Panama
    - Project Valhalla
    - Project Amber
      - Right sizing language ceremony
      - Type inference of variable
        - Production release in next march
      - Pattern match
    - Project Loom

## RDBMS to Kafka: Stories from the Message Bus Stop [CON7374]
- What is Kafka
  - Kafka controls offset of Consumer group and producer
    - Even if a consumer crashed and reloaded, it can see same data again because it's event and kafka controls offset
      - It cannot in DB because it's state
  - High and Low level Java API
  - Kafka connect
  - Kafka REST Proxy
  - Third-party tools
- State and Events
  - database give you state
    - DB(REDO) Log is a event
  - Kafka give you event
- Usecase
  - Migrating legacy system
    - Put data in legacy system to kafka, and consume it to modern system
  - Replication
- https://github.com/confluentinc/schema-registry
- Live Demo
  - produce data in mysql, oracle DB using kafka connect
    - Delete is not produced to kafka as default
      - Using flashback query in oracle db, it can be
    - kafka-connect-jdbc has issues
      - oracle number to javaint
      - schema changes
      - UTC timezone issues
  - replicate using dbvisit
- Oracle goldengate integrated producer
  - redo -> ogg extract to trail failes -> ogg-bd for replicate to kafka -> kafka

## Shenandoah 2.0: Now That Weâ€™ve Gotten the GC Pause Times Under Control, Whatâ€™s Next? [CON6108]
- To be filled

## Using Type Annotations to Improve Your Code [BOF3048]
- Type annotation is introduced in Java 8
  - it stored in classfile
  - Hnadled by javac, javap, javadoc
  - But it has no effect unless you run an annotation processor
  - Write annotation before type
    - For `String [][]`, a readonly array of nonempty array of english string will be `@English String @Readonly [] @NonEmpty[] a`
    - For reciever of method, we can consider all of instance method takes reciever also.
      - `equals(Object other)` takes two parameter, reciever(`this`) and `other`
      - `equals(MyClass this, Object other)`, `equals(@ReadOnly MyClass this, @ReadOnly Object other)`,
    - For constructor return, every constructor has a return type
      - `@TReturn MyClass() {}`
  - Why annotation?
    - Annotations are a specification
- Pluggable Type Systems
  - CheckerFramework
  - mostly same as a session in this morning
  - Type inference in method
    - called Flow-sensitive refinement
  - Whole program inference(as beta)
- Type Annotations in Java 9 and Future
  - Java 9
    - implementation improvements
  - Java >9
    - What annotation-related feature are you missing?
      - Statement annotations
      - More expressive annotation attributes
      - Annotation inheritance

## JSF 2.3 in Action [BOF2723]
- Author of JavaServerFaces in Action
- History of JSF 2.3
  - Started in Sep 2014
  - Completed in Apr 2017
  - Heavily community-driven
    - PrimeFaces folks
- Themes
  -Java EE alignment
    - Full support for CDI
    - Websocket
    - Class-level bean validation
  - Java 8 alighnment
    - DateTime API, generics, etc
    - a lot of small fixes
- JSF 2.3 in Action
  - `ui:repeat`, `<h:dataTable>` for map and iterable
    ```
      <ui:repeat value=#{data.map} var="item">
        #{item.key}
        #{item.value}
      </ui:repeat>
    ```
  - `ManagedBean` is deprecated, use `Named`
    -`javax.faces.beans.ManagedProperty` -> `javax.faces.annotation.ManagedProperty`
  - `ui:repeat` with `step`
  - `FacesConfig`
  - `@Inject` on `FacesContext`, `RequestParameterMap`, `ViewMap` and so on
  - `ProjectStage` and `isProjectStage`
    - refer static field with `f:importConstants`
  - Websocket
    - Add `ENABLE_WEBSOCKET_ENDPOINT` in `web.xml`
  - Offical support for dynamic omponent tree manipulation
  - Retreiving a list of all view resources
  - Standardized resource rendered tracking
  - Generics for converter and Validator interface
  - Facelets disables hot re-loading by default if ProjectStage == Production
  - Auto conversion in UISelectMany for collection
  - Freely placeable radio button
  - Java 8 DateTime API at convertDateTime
  - Updating multiple forms via AJAX
